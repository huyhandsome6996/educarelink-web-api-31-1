<!DOCTYPE html>
<html class="light" lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Care Partner Registration - EduCare Link</title>
    
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#10bc83",
                        "secondary": "#136dec", 
                        "background-light": "#f6f8f7",
                        "background-dark": "#10221c",
                        "mint": "#e6fcf5",
                        "emerald-dark": "#064e3b"
                    },
                    fontFamily: { "display": ["Lexend", "sans-serif"] },
                },
            },
        }
    </script>
    <style>
        .glass-panel {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        .glass-input {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(4px);
        }
        body { background: linear-gradient(135deg, #e0f7fa 0%, #e8f5e9 100%); }
    </style>
</head>

<body class="bg-background-light font-display text-[#0d1b17] min-h-screen relative overflow-x-hidden">
    <div class="relative z-10 flex flex-col min-h-screen pb-32">
        
        <header class="flex items-center p-4 pt-6 pb-2 justify-between sticky top-0 z-50 glass-panel mb-4 shadow-sm">
            <button onclick="window.location.href='/dashboard/'" class="flex size-10 shrink-0 items-center justify-center rounded-full hover:bg-black/5 transition-colors">
                <span class="material-symbols-outlined text-[#0d1b17]">arrow_back_ios_new</span>
            </button>
            <h2 class="text-[#0d1b17] text-lg font-bold leading-tight flex-1 text-center truncate px-2">Trở thành Care Partner</h2>
            <div class="w-10"></div>
        </header>

        <div id="status-area" class="px-4"></div>

        <section class="px-4 mb-6">
            <h1 class="text-[#0d1b17] tracking-tight text-3xl font-bold leading-tight mb-6">Quyền lợi đối tác</h1>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="flex flex-row items-center gap-4 rounded-xl border border-[#cfe7df] bg-white/60 p-4 shadow-sm">
                    <div class="size-12 rounded-full bg-primary/20 flex items-center justify-center shrink-0">
                        <span class="material-symbols-outlined text-primary">payments</span>
                    </div>
                    <div class="flex flex-col gap-1">
                        <h2 class="text-base font-bold">Thu nhập hấp dẫn</h2>
                        <p class="text-gray-500 text-sm">Thu nhập lên tới 15tr/tháng</p>
                    </div>
                </div>
                </div>
        </section>

        <form id="cpForm" class="px-4 space-y-6">
            
            <div class="glass-panel rounded-2xl p-5 shadow-sm">
                <div class="flex items-center gap-2 mb-6 border-b border-gray-100 pb-4">
                    <span class="material-symbols-outlined text-primary">badge</span>
                    <h3 class="text-lg font-bold">Thông tin chuyên môn</h3>
                </div>

                <div class="mb-5">
                    <label class="block text-sm font-semibold mb-2 ml-1">Chuyên ngành *</label>
                    <input name="chuyen_nganh" class="glass-input w-full rounded-xl border border-[#cfe7df] focus:ring-primary focus:border-primary h-14 pl-4 pr-4" placeholder="VD: Sư phạm mầm non..." type="text" required />
                </div>

                <div class="mb-5">
                    <label class="block text-sm font-semibold mb-2 ml-1">Trường đào tạo *</label>
                    <input name="truong" class="glass-input w-full rounded-xl border border-[#cfe7df] focus:ring-primary focus:border-primary h-14 pl-4 pr-4" placeholder="Nhập tên trường..." type="text" required />
                </div>

                <div class="mb-2">
                    <label class="block text-sm font-semibold mb-2 ml-1">Kỹ năng & Kinh nghiệm *</label>
                    <textarea name="ky_nang" class="glass-input w-full rounded-xl border border-[#cfe7df] focus:ring-primary focus:border-primary min-h-[120px] p-4 resize-none" placeholder="Mô tả kinh nghiệm và kỹ năng..." required></textarea>
                </div>
            </div>

            <div>
                <div class="mb-4 flex items-center justify-between px-1">
                    <h3 class="text-lg font-bold">Hồ sơ đính kèm</h3>
                    <span class="text-xs font-medium text-primary bg-primary/10 px-2 py-1 rounded-full">Bắt buộc</span>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <label id="cccd-label" class="group relative flex flex-col items-center justify-center h-40 rounded-xl border-2 border-dashed border-gray-300 bg-white/40 hover:border-primary hover:bg-primary/5 transition-all cursor-pointer">
                        <input name="anh_cccd" class="hidden" type="file" accept="image/*" onchange="handleFile(this, 'cccd-label', 'id_card')" required />
                        <div class="mb-3 p-3 bg-white rounded-full shadow-sm group-hover:scale-110 transition-transform">
                            <span class="material-symbols-outlined text-gray-500 group-hover:text-primary">id_card</span>
                        </div>
                        <span id="cccd-text" class="text-sm font-bold text-gray-700 group-hover:text-primary text-center px-2 truncate w-full">Ảnh CCCD</span>
                        <div id="cccd-check" class="hidden absolute top-2 right-2 size-5 bg-green-500 rounded-full flex items-center justify-center">
                            <span class="material-symbols-outlined text-white text-[14px]">check</span>
                        </div>
                    </label>

                    <label id="degree-label" class="group relative flex flex-col items-center justify-center h-40 rounded-xl border-2 border-dashed border-gray-300 bg-white/40 hover:border-secondary hover:bg-secondary/5 transition-all cursor-pointer">
                        <input name="bang_cap" class="hidden" type="file" accept="image/*" onchange="handleFile(this, 'degree-label', 'workspace_premium')" required />
                        <div class="mb-3 p-3 bg-white rounded-full shadow-sm group-hover:scale-110 transition-transform">
                            <span class="material-symbols-outlined text-gray-500 group-hover:text-secondary">workspace_premium</span>
                        </div>
                        <span id="degree-text" class="text-sm font-bold text-gray-700 group-hover:text-secondary text-center px-2 truncate w-full">Bằng cấp</span>
                        <div id="degree-check" class="hidden absolute top-2 right-2 size-5 bg-green-500 rounded-full flex items-center justify-center">
                            <span class="material-symbols-outlined text-white text-[14px]">check</span>
                        </div>
                    </label>
                </div>
            </div>
        </form>
    </div>

    <div class="fixed bottom-0 left-0 w-full p-4 pb-8 z-50 glass-panel border-t-0 rounded-t-2xl shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.1)]">
        <div class="max-w-md mx-auto w-full">
            <button id="submit-btn" onclick="submitForm()" class="w-full relative overflow-hidden group rounded-xl h-14 shadow-lg shadow-primary/25 hover:shadow-primary/40 transition-all active:scale-[0.98]">
                <div class="absolute inset-0 bg-gradient-to-r from-primary to-secondary w-full h-full"></div>
                <div class="relative flex items-center justify-center gap-2 text-white font-bold text-lg tracking-wide">
                    <span id="btn-text">Gửi hồ sơ đăng ký</span>
                    <span class="material-symbols-outlined">send</span>
                </div>
            </button>
            <p class="text-center text-xs text-gray-500 mt-3 flex items-center justify-center gap-1">
                <span class="material-symbols-outlined text-primary text-[14px]">verified_user</span>
                Hồ sơ sẽ được duyệt trong 24-48h làm việc
            </p>
        </div>
    </div>

    <div id="success-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/60 p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl scale-100 transform transition-transform">
            <div class="size-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <span class="material-symbols-outlined text-5xl">check_circle</span>
            </div>
            <h3 class="text-2xl font-bold text-slate-800 mb-2">Gửi thành công!</h3>
            <p class="text-slate-500 mb-8 leading-relaxed">Hồ sơ của bạn đã được chuyển đến bộ phận kiểm duyệt. Kết quả sẽ được thông báo sớm nhất.</p>
            <button onclick="window.location.href='/dashboard/'" class="w-full bg-primary hover:bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg transition-all">
                Về trang chủ
            </button>
        </div>
    </div>

    <script>
        // 1. Helper: CSRF Token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break;
                    }
                }
            }
            return cookieValue;
        }

        // 2. Logic Upload File UX
        function handleFile(input, labelId, iconName) {
            const label = document.getElementById(labelId);
            const text = label.querySelector('span[id$="-text"]');
            const check = label.querySelector('div[id$="-check"]');
            
            if (input.files && input.files[0]) {
                text.innerText = input.files[0].name;
                text.classList.add('text-primary');
                label.classList.add('border-primary', 'bg-primary/5');
                check.classList.remove('hidden');
            }
        }

        // 3. Logic Submit Form
        async function submitForm() {
            const form = document.getElementById('cpForm');
            const btn = document.getElementById('submit-btn');
            const btnText = document.getElementById('btn-text');
            const statusArea = document.getElementById('status-area');

            // Validate sơ bộ HTML5
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // UI Loading state
            btn.disabled = true;
            btnText.innerText = "Đang tải lên...";
            statusArea.innerHTML = '';

            const formData = new FormData(form); // Tự động gom data

            try {
                const res = await fetch("/api/carepartner/register/", {
                    method: "POST",
                    headers: { 'X-CSRFToken': getCookie('csrftoken') },
                    body: formData
                });
                
                const data = await res.json(); //

                if (data.status === 'ok') {
                    document.getElementById('success-modal').classList.remove('hidden');
                } 
                else if (data.status === 'already_registered') {
                    statusArea.innerHTML = `<div class="bg-orange-50 border border-orange-200 text-orange-800 px-4 py-3 rounded-xl mb-4 text-sm font-bold flex items-center gap-2"><span class="material-symbols-outlined">info</span>Bạn đã nộp hồ sơ rồi. Vui lòng chờ duyệt.</div>`;
                }
                else {
                    statusArea.innerHTML = `<div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-xl mb-4 text-sm font-bold flex items-center gap-2"><span class="material-symbols-outlined">error</span>Lỗi: ${data.msg || data.status}</div>`;
                }
            } catch (err) {
                statusArea.innerHTML = `<div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-xl mb-4 text-sm font-bold">Lỗi kết nối máy chủ.</div>`;
            } finally {
                btn.disabled = false;
                btnText.innerText = "Gửi hồ sơ đăng ký";
            }
        }

        // Auto check login
        (async () => {
            const res = await fetch("/api/me/");
            const data = await res.json();
            if (!data.login) window.location = "/dangnhap/";
        })();
    </script>
</body>
</html>