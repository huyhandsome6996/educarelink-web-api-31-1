<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>ƒê·∫∑t d·ªãch v·ª•</title>
</head>

<body>

<h2>ƒê·∫∑t d·ªãch v·ª•</h2>

<p>Th·ªùi gian b·∫Øt ƒë·∫ßu:</p>
<input type="datetime-local" id="start"><br><br>

<p>Th·ªùi gian k·∫øt th√∫c:</p>
<input type="datetime-local" id="end"><br><br>

<p>ƒê·ªãa ch·ªâ:</p>
<input id="dia_chi" style="width:300px;"><br><br>

<p>M√¥ t·∫£ tr·∫ª:</p>
<textarea id="tre_mo_ta"></textarea><br><br>

<p>Y√™u c·∫ßu th√™m:</p>
<textarea id="yeu_cau"></textarea><br><br>

<button onclick="tinhGia()">T√≠nh gi√°</button>

<h3 id="gia">Gi√° t·∫°m t√≠nh: 0 VND</h3>

<button onclick="gui()">G·ª≠i y√™u c·∫ßu</button>

<script>

const urlParams = new URLSearchParams(window.location.search);
const service_id = urlParams.get("service");

let giaTam = 0;


// ===== T√çNH GI√Å =====
async function tinhGia(){

    const r = await fetch("/api/tinhgia/",{
        method:"POST",
        headers:{
            "Content-Type":"application/json",
            "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify({
            service_id: service_id,
            start: document.getElementById("start").value,
            end: document.getElementById("end").value
        })
    });

    const d = await r.json();

    if(d.status==="ok"){
        giaTam = d.gia;
        document.getElementById("gia").innerText =
            "Gi√° t·∫°m t√≠nh: "+d.gia+" VND";
    }else{
        alert("Kh√¥ng t√≠nh ƒë∆∞·ª£c gi√°");
    }
}


// ===== G·ª¨I BOOKING =====
async function gui(){

    if(giaTam==0){
        alert("H√£y t√≠nh gi√° tr∆∞·ªõc!");
        return;
    }

    const r = await fetch("/api/booking/create/",{
        method:"POST",
        headers:{
            "Content-Type":"application/json",
            "X-CSRFToken": getCookie("csrftoken")
        },
        body:JSON.stringify({
            service_id: service_id,
            start: document.getElementById("start").value,
            end: document.getElementById("end").value,

            dia_chi: document.getElementById("dia_chi").value,
            tre_mo_ta: document.getElementById("tre_mo_ta").value,
            yeu_cau: document.getElementById("yeu_cau").value,

            gia_tam_tinh: giaTam   // üî• S·ª¨A ·ªû ƒê√ÇY
        })
    });

    const d = await r.json();

    if(d.status==="ok"){
        alert("G·ª≠i y√™u c·∫ßu th√†nh c√¥ng!");
        window.location="/dashboard/";
    }else{
        alert("L·ªói g·ª≠i booking");
        console.log(d); // debug
    }
}


// ===== L·∫§Y CSRF TOKEN =====
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

</script>

</body>
</html>
