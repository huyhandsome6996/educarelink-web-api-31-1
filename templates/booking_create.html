<!DOCTYPE html>
<html class="light" lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>EduCare Link - Tạo yêu cầu</title>
    
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&family=Noto+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#136dec",
                        "secondary-orange": "#f97316",
                        "glass-border": "rgba(255, 255, 255, 0.4)",
                        "glass-bg": "rgba(255, 255, 255, 0.65)",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"],
                        "body": ["Noto Sans", "sans-serif"],
                    },
                    boxShadow: {
                        "glass": "0 8px 32px 0 rgba(31, 38, 135, 0.07)",
                        "soft": "0 10px 40px -10px rgba(0,0,0,0.08)",
                    }
                },
            },
        }
    </script>

    <style>
        body {
            background: linear-gradient(-45deg, #f6f7f8, #e0e7ff, #f0f9ff, #ffffff);
            background-size: 400% 400%;
            animation: gradient-animation 15s ease infinite;
            min-height: 100vh;
        }
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        .service-card.active {
            border-color: #136dec !important;
            background-color: rgba(19, 109, 236, 0.05) !important;
            box-shadow: 0 4px 12px rgba(19, 109, 236, 0.15);
        }
        .service-card.active .icon-box {
            background-color: #136dec !important;
            color: #ffffff !important;
        }
    </style>
</head>

<body class="text-slate-800 font-body relative pb-32">
    <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
        <div class="absolute top-[-10%] left-[-10%] w-[300px] h-[300px] bg-blue-300/20 rounded-full blur-[80px]"></div>
        <div class="absolute bottom-[10%] right-[-10%] w-[250px] h-[250px] bg-orange-200/20 rounded-full blur-[60px]"></div>
    </div>

    <div class="relative z-10 mx-auto w-full max-w-[480px] flex flex-col">
        <header class="flex items-center bg-white/70 backdrop-blur-md sticky top-0 z-50 p-4 border-b border-white/40 shadow-sm">
            <button onclick="window.history.back()" class="size-10 flex items-center justify-center rounded-full hover:bg-white transition-colors">
                <span class="material-symbols-outlined text-slate-600">arrow_back</span>
            </button>
            <h2 class="text-lg font-display font-bold flex-1 text-center pr-10 text-slate-800">Tạo yêu cầu mới</h2>
        </header>

        <div class="px-5 mt-6 flex flex-col gap-6">
            
            <div>
                <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-3 ml-1">1. Chọn dịch vụ</h3>
                <div id="service-grid" class="grid grid-cols-2 gap-3">
                    <div class="h-24 rounded-2xl bg-white/50 animate-pulse"></div>
                    <div class="h-24 rounded-2xl bg-white/50 animate-pulse"></div>
                </div>
            </div>

            <div class="glass-card p-4 rounded-2xl">
                <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-3">2. Thời gian</h3>
                <div class="flex flex-col gap-4">
                    <div>
                        <label class="text-xs font-semibold text-primary mb-1 block">Bắt đầu</label>
                        <input id="start-time" type="datetime-local" class="w-full bg-white/50 border border-slate-200 rounded-xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-slate-700 font-medium">
                    </div>
                    <div>
                        <label class="text-xs font-semibold text-primary mb-1 block">Kết thúc</label>
                        <input id="end-time" type="datetime-local" class="w-full bg-white/50 border border-slate-200 rounded-xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-slate-700 font-medium">
                    </div>
                </div>
            </div>

            <div class="glass-card p-4 rounded-2xl">
                <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-3">3. Địa điểm</h3>
                <div class="relative">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">location_on</span>
                    <input id="address" type="text" class="w-full pl-10 pr-4 py-3 bg-white/50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all font-medium placeholder:text-slate-400" placeholder="Nhập địa chỉ nhà bạn...">
                </div>
            </div>

            <div class="glass-card p-4 rounded-2xl">
                <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-3">4. Thông tin chi tiết</h3>
                <div class="flex flex-col gap-4">
                    <div>
                        <label class="text-xs font-semibold text-slate-600 mb-1 block">Mô tả về bé *</label>
                        <textarea id="child-desc" rows="3" class="w-full bg-white/50 border border-slate-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400" placeholder="Tuổi, tính cách, những điều cần lưu ý..."></textarea>
                    </div>
                    <div>
                        <label class="text-xs font-semibold text-slate-600 mb-1 block">Yêu cầu thêm</label>
                        <textarea id="extra-req" rows="2" class="w-full bg-white/50 border border-slate-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400" placeholder="Ví dụ: Biết nấu ăn, có xe máy..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 p-4 z-50">
        <div class="mx-auto max-w-[480px]">
            <div class="glass-card rounded-2xl p-4 shadow-xl border-t border-white/60 flex items-center justify-between gap-4">
                <div class="flex flex-col">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Tổng tạm tính</span>
                    <div class="flex items-baseline gap-1">
                        <span id="display-price" class="text-2xl font-display font-bold text-primary">0</span>
                        <span class="text-sm font-bold text-primary">đ</span>
                    </div>
                    <span id="duration-text" class="text-[10px] font-medium text-slate-500 hidden">-- giờ</span>
                </div>
                
                <button id="submit-btn" class="flex-1 bg-gradient-to-r from-primary to-blue-600 hover:to-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-500/30 transition-all active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed">
                    Gửi yêu cầu
                </button>
            </div>
        </div>
    </div>

    <script>
        let selectedServiceId = null;
        let finalPrice = 0;

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break;
                    }
                }
            }
            return cookieValue;
        }

        async function loadServices() {
            const grid = document.getElementById('service-grid');
            try {
                const res = await fetch('/api/services/'); //
                const result = await res.json(); //
                
                // Lấy service_id từ URL nếu có (để auto-select)
                const urlParams = new URLSearchParams(window.location.search);
                const preSelectedId = urlParams.get('service_id');

                grid.innerHTML = result.data.map(s => `
                    <div onclick="selectService(this, ${s.id})" 
                         class="service-card group bg-white/60 border border-white rounded-2xl p-4 cursor-pointer transition-all hover:shadow-soft flex flex-col gap-3"
                         id="service-${s.id}">
                        <div class="icon-box size-10 rounded-xl bg-blue-50 text-primary flex items-center justify-center transition-colors">
                            <span class="material-symbols-outlined text-[24px]">child_care</span>
                        </div>
                        <div class="flex flex-col">
                            <h4 class="font-display font-bold text-slate-800 text-sm leading-tight">${s.ten}</h4>
                            <p class="font-body text-xs font-semibold text-slate-500 mt-1">${s.gia_moi_gio.toLocaleString()}đ/h</p>
                        </div>
                    </div>
                `).join('');

                if (preSelectedId) {
                    const el = document.getElementById(`service-${preSelectedId}`);
                    if (el) selectService(el, preSelectedId);
                }

            } catch (err) { grid.innerHTML = "Lỗi tải dịch vụ."; }
        }

        function selectService(el, id) {
            document.querySelectorAll('.service-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            selectedServiceId = id;
            updatePrice();
        }

        async function updatePrice() {
            const start = document.getElementById('start-time').value;
            const end = document.getElementById('end-time').value;
            const durationText = document.getElementById('duration-text');

            if (!selectedServiceId || !start || !end) {
                durationText.classList.add('hidden');
                return;
            }

            try {
                const res = await fetch('/api/tinhgia/', { //
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                    body: JSON.stringify({ service_id: selectedServiceId, start, end }) //
                });
                const result = await res.json();
                
                if (result.status === 'ok') {
                    finalPrice = result.gia;
                    document.getElementById('display-price').innerText = finalPrice.toLocaleString();
                    
                    // Hiển thị số giờ
                    const diffMs = new Date(end) - new Date(start);
                    const diffHrs = (diffMs / 3600000).toFixed(1);
                    if (diffHrs > 0) {
                        durationText.innerText = `${diffHrs} tiếng`;
                        durationText.classList.remove('hidden');
                    }
                }
            } catch (err) { console.error(err); }
        }

        document.getElementById('submit-btn').addEventListener('click', async () => {
            const btn = document.getElementById('submit-btn');
            const data = {
                service_id: selectedServiceId,
                start: document.getElementById('start-time').value,
                end: document.getElementById('end-time').value,
                dia_chi: document.getElementById('address').value,
                tre_mo_ta: document.getElementById('child-desc').value, //
                yeu_cau: document.getElementById('extra-req').value, //
                gia_tam_tinh: finalPrice
            };

            if (!data.service_id || !data.start || !data.end || !data.dia_chi || !data.tre_mo_ta) {
                alert("Vui lòng điền đầy đủ các thông tin bắt buộc!"); return;
            }

            btn.disabled = true;
            btn.innerHTML = `<span class="material-symbols-outlined animate-spin text-sm mr-2">progress_activity</span> Đang gửi...`;

            try {
                const res = await fetch('/api/booking/create/', { //
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                    body: JSON.stringify(data) //
                });
                const result = await res.json();
                if (result.status === 'ok') {
                    // Hiệu ứng thành công nhỏ trước khi chuyển trang
                    btn.classList.remove('from-primary', 'to-blue-600');
                    btn.classList.add('bg-green-500');
                    btn.innerHTML = `<span class="material-symbols-outlined mr-2">check</span> Thành công!`;
                    setTimeout(() => window.location.href = '/dashboard/', 1000);
                } else { 
                    alert("Lỗi: " + result.msg);
                    btn.disabled = false;
                    btn.innerText = "Gửi yêu cầu";
                }
            } catch (err) { 
                alert("Lỗi kết nối.");
                btn.disabled = false;
                btn.innerText = "Gửi yêu cầu";
            }
        });

        document.getElementById('start-time').addEventListener('change', updatePrice);
        document.getElementById('end-time').addEventListener('change', updatePrice);
        
        // Khởi tạo
        loadServices();
    </script>
</body>
</html>