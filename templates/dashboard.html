<!DOCTYPE html>
<html class="light" lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>EduCare Link - Dashboard</title>
    
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&family=Noto+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#136dec",
                        "secondary-orange": "#f97316",
                        "glass-border": "rgba(255, 255, 255, 0.4)",
                        "glass-bg": "rgba(255, 255, 255, 0.65)",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"],
                        "body": ["Noto Sans", "sans-serif"],
                    },
                    boxShadow: {
                        "glass": "0 8px 32px 0 rgba(31, 38, 135, 0.07)",
                        "soft": "0 10px 40px -10px rgba(0,0,0,0.08)",
                    }
                },
            },
        }
    </script>

    <style>
        body {
            background: linear-gradient(-45deg, #f6f7f8, #e0e7ff, #f0f9ff, #ffffff);
            background-size: 400% 400%;
            animation: gradient-animation 15s ease infinite;
            min-height: 100vh;
        }
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .material-symbols-outlined { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .glass-card {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        /* Hiệu ứng nhấp nháy cho đơn cần duyệt */
        @keyframes pulse-border {
            0% { border-color: rgba(249, 115, 22, 0.4); }
            50% { border-color: rgba(249, 115, 22, 1); }
            100% { border-color: rgba(249, 115, 22, 0.4); }
        }
        .action-required {
            border: 2px solid #f97316;
            animation: pulse-border 2s infinite;
        }
    </style>
</head>

<body class="bg-[#f6f7f8] text-slate-800 font-body relative pb-24">
    <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
        <div class="absolute top-[-10%] left-[-10%] w-[300px] h-[300px] bg-blue-300/20 rounded-full blur-[80px]"></div>
        <div class="absolute top-[15%] right-[-10%] w-[250px] h-[250px] bg-orange-200/20 rounded-full blur-[60px]"></div>
    </div>

    <div class="relative z-10 mx-auto w-full max-w-[480px] flex flex-col">
        <div class="sticky top-0 z-50 px-5 py-4 bg-white/70 backdrop-blur-xl border-b border-white/40 shadow-sm">
            <div class="flex flex-col gap-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="relative">
                            <div class="size-11 rounded-full border-2 border-white shadow-md bg-cover bg-center" style='background-image: url("https://img.freepik.com/free-vector/user-blue-gradient_78370-4692.jpg");'></div>
                            <div class="absolute bottom-0 right-0 size-3 bg-green-500 rounded-full border-2 border-white"></div>
                        </div>
                        <div class="flex flex-col">
                            <h1 id="userName" class="font-display text-lg font-bold text-slate-900 leading-tight">Chào bạn</h1>
                            <p id="userRole" class="text-xs text-slate-500 font-medium tracking-wide">Đang tải...</p>
                        </div>
                    </div>
                    <button onclick="handleLogout()" class="size-10 flex items-center justify-center rounded-full bg-white/50 hover:bg-white text-slate-600 border border-white/60 shadow-sm transition-colors">
                        <span class="material-symbols-outlined text-[20px]">logout</span>
                    </button>
                </div>
                <div class="flex items-center gap-3">
                    <button id="btnSwitch" onclick="handleSwitchMode()" class="hidden flex-1 flex items-center justify-center gap-2 h-11 px-4 rounded-full bg-white/60 border border-slate-200 shadow-sm text-slate-700 text-sm font-semibold hover:bg-white transition-all group">
                        <span class="material-symbols-outlined text-[18px] text-slate-500 group-hover:text-primary transition-colors">sync_alt</span>
                        <span class="truncate">Chuyển chế độ</span>
                    </button>
                    <button id="btnRegisterPartner" onclick="window.location.href='/carepartner/'" class="hidden flex-1 flex items-center justify-center gap-2 h-11 px-4 rounded-full bg-secondary-orange text-white shadow-lg shadow-orange-500/20 text-sm font-semibold hover:bg-orange-600 transition-all">
                        <span class="material-symbols-outlined text-[18px]">handshake</span>
                        <span class="truncate">Đăng ký đối tác</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="px-5 flex flex-col gap-8 mt-6">
            <div class="group relative overflow-hidden rounded-[28px] glass-card shadow-glass p-1">
                <div class="relative z-10 flex flex-col p-5 pb-6">
                    <div class="flex justify-between items-start mb-1">
                        <div class="w-2/3">
                            <div class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-blue-100/50 border border-blue-200/50 text-primary text-[10px] font-bold mb-3 uppercase tracking-wider">
                                <span class="material-symbols-outlined text-[14px]">smart_toy</span> AI Support
                            </div>
                            <h2 class="font-display text-2xl font-bold text-slate-900 mb-2 leading-tight">Cần trợ giúp?</h2>
                            <p class="text-sm text-slate-600 leading-relaxed font-medium">Trợ lý AI sẵn sàng giải đáp thắc mắc.</p>
                        </div>
                    </div>
                    <button onclick="openTidioChat()" class="mt-4 w-full h-12 flex items-center justify-center gap-2 bg-primary text-white rounded-2xl font-bold shadow-lg shadow-blue-500/25 hover:bg-blue-600 active:scale-[0.98] transition-all">
                        <span class="material-symbols-outlined text-[20px]">chat_bubble</span> Trò chuyện ngay
                    </button>
                </div>
                <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-blue-400/10 blur-2xl rounded-full"></div>
            </div>

            <div id="bookingSection" class="hidden flex flex-col gap-4">
                <div class="flex items-end justify-between px-1">
                    <h3 class="font-display text-[20px] font-bold text-slate-900 leading-none">Hoạt động gần đây</h3>
                    <a class="text-sm font-semibold text-primary hover:underline" href="#">Tất cả</a>
                </div>
                <div id="bookingList" class="flex flex-col gap-3">
                    <p class="text-xs text-slate-400 italic text-center py-4">Đang tải danh sách đơn...</p>
                </div>
            </div>

            <div id="parentView" class="flex flex-col gap-5">
                <div class="flex items-end justify-between px-1">
                    <h3 class="font-display text-[20px] font-bold text-slate-900 leading-none">Dịch vụ</h3>
                </div>
                <div id="serviceGrid" class="grid grid-cols-2 gap-4">
                    <div class="animate-pulse bg-white/50 h-32 rounded-[24px]"></div>
                    <div class="animate-pulse bg-white/50 h-32 rounded-[24px]"></div>
                </div>
            </div>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bottom-nav h-20 px-8 flex items-center justify-between z-50">
        <a href="/dashboard/" class="flex flex-col items-center text-primary">
            <span class="material-symbols-outlined">home</span>
            <span class="text-[10px] font-bold mt-1 uppercase">Trang chủ</span>
        </a>
        <a href="#" class="flex flex-col items-center text-slate-400 hover:text-primary transition-colors">
            <span class="material-symbols-outlined">assignment</span>
            <span class="text-[10px] font-bold mt-1 uppercase">Hoạt động</span>
        </a>
        <a href="/profile/" class="flex flex-col items-center text-slate-400 hover:text-primary transition-colors">
            <span class="material-symbols-outlined">person</span>
            <span class="text-[10px] font-bold mt-1 uppercase">Hồ sơ</span>
        </a>
    </nav>

    <script>
        let currentMode = "parent";

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break;
                    }
                }
            }
            return cookieValue;
        }

        // Map trạng thái sang tiếng Việt và màu sắc
        const STATUS_MAP = {
            'pending': { text: 'Đang tìm người...', color: 'text-slate-500 bg-slate-100' },
            'applied': { text: 'Có người ứng tuyển!', color: 'text-white bg-orange-500 animate-pulse' }, // Highlight
            'confirmed': { text: 'Đã xác nhận', color: 'text-blue-600 bg-blue-100' },
            'doing': { text: 'Đang thực hiện', color: 'text-green-600 bg-green-100' },
            'done': { text: 'Hoàn thành', color: 'text-slate-600 bg-slate-200' }
        };

        async function initDashboard() {
            try {
                // 1. User Info
                const userRes = await fetch('/api/me/'); //
                const userData = await userRes.json();
                if (!userData.login) { window.location.href = '/dangnhap/'; return; }

                document.getElementById('userName').innerText = `Chào bạn, ${userData.username}`;
                
                // 2. Mode
                const modeRes = await fetch('/api/mode/');
                const modeData = await modeRes.json();
                currentMode = modeData.mode || "parent";
                document.getElementById('userRole').innerText = currentMode === "parent" ? "Chế độ: Phụ huynh" : "Chế độ: Care Partner";

                // 3. UI Toggles
                const btnSwitch = document.getElementById('btnSwitch');
                const btnReg = document.getElementById('btnRegisterPartner');
                const bookingSec = document.getElementById('bookingSection');
                
                if (userData.is_carepartner) {
                    btnReg.classList.add('hidden');
                    btnSwitch.classList.remove('hidden');
                } else {
                    btnReg.classList.remove('hidden');
                    btnSwitch.classList.add('hidden');
                }

                if (currentMode === "parent") {
                    bookingSec.classList.remove('hidden');
                    loadMyBookings(); // Tải danh sách đơn
                }

                loadServices();
            } catch (err) { console.error("Lỗi init:", err); }
        }

        async function loadServices() {
            const grid = document.getElementById('serviceGrid');
            try {
                const res = await fetch('/api/services/');
                const result = await res.json();
                grid.innerHTML = result.data.map(s => `
                    <div onclick="window.location.href='/booking/create/?service_id=${s.id}'" 
                         class="group flex flex-col p-5 gap-3 bg-white/65 backdrop-blur-lg border border-white/40 rounded-[24px] shadow-sm hover:shadow-soft transition-all cursor-pointer hover:border-primary/30">
                        <div class="size-12 rounded-2xl bg-blue-50 text-primary flex items-center justify-center group-hover:bg-primary group-hover:text-white transition-colors">
                            <span class="material-symbols-outlined text-[28px]">child_care</span>
                        </div>
                        <div class="flex flex-col gap-1 mt-1">
                            <h4 class="font-display font-bold text-slate-900 text-[15px] leading-tight">${s.ten}</h4>
                            <p class="font-body text-xs font-semibold text-slate-500">Từ ${s.gia_moi_gio.toLocaleString()}đ/giờ</p>
                        </div>
                    </div>
                `).join('');
            } catch (err) { grid.innerHTML = "<p class='text-xs text-slate-400'>Lỗi tải dịch vụ.</p>"; }
        }

        async function loadMyBookings() {
            const list = document.getElementById('bookingList');
            try {
                const res = await fetch('/api/my-bookings/'); //
                const result = await res.json();
                
                if (result.data && result.data.length > 0) {
                    list.innerHTML = result.data.map(b => {
                        const st = STATUS_MAP[b.status] || { text: b.status, color: 'bg-gray-100 text-gray-500' };
                        // Nếu status là 'applied', thêm class viền cam để nổi bật
                        const extraClass = b.status === 'applied' ? 'action-required shadow-lg' : 'hover:bg-white/90';
                        
                        return `
                        <div onclick="window.location.href='/booking/detail/?id=${b.id}'" 
                             class="glass-card p-4 rounded-2xl flex items-center justify-between cursor-pointer transition-all ${extraClass}">
                            <div class="flex items-center gap-3">
                                <div class="size-10 rounded-xl bg-blue-50 text-primary flex items-center justify-center">
                                    <span class="material-symbols-outlined text-[20px]">calendar_month</span>
                                </div>
                                <div>
                                    <h4 class="text-sm font-bold text-slate-900 line-clamp-1">${b.service}</h4>
                                    <p class="text-[10px] text-slate-500">ID: #${b.id} • ${b.price.toLocaleString()}đ</p>
                                </div>
                            </div>
                            <span class="px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wider ${st.color}">
                                ${st.text}
                            </span>
                        </div>
                        `;
                    }).join('');
                } else {
                    list.innerHTML = `<div class="p-4 text-center text-xs text-slate-400 bg-white/40 rounded-2xl border border-dashed border-slate-300">Bạn chưa có đơn đặt hàng nào.</div>`;
                }
            } catch (err) { console.error(err); }
        }

        async function handleSwitchMode() {
            const targetMode = currentMode === "parent" ? "carepartner" : "parent";
            const res = await fetch('/api/mode/switch/', { //
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                body: JSON.stringify({ mode: targetMode })
            });
            const result = await res.json();
            if (result.status === 'ok') location.reload();
            else alert(result.status === 'not_approved' ? "Tài khoản đối tác chưa được duyệt!" : "Lỗi chuyển chế độ.");
        }

        async function handleLogout() {
            if (confirm("Đăng xuất khỏi hệ thống?")) {
                await fetch('/api/logout/', { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
                window.location.href = '/dangnhap/';
            }
        }

        function openTidioChat() {
            if (window.tidioChatApi) window.tidioChatApi.open();
            else alert("Chatbot đang kết nối...");
        }

        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>